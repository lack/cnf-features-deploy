# Automatically generated by extra-manifests-builder
# Do not make changes directly.
apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  labels:
    machineconfiguration.openshift.io/role: worker
  name: container-mount-namespace-and-kubelet-conf-worker
spec:
  config:
    ignition:
      version: 3.2.0
    storage:
      files:
      - contents:
          source: data:text/plain;charset=utf-8;base64,IyEvYmluL2Jhc2gKCmRlYnVnKCkgewogIGVjaG8gJEAgPiYyCn0KCnVzYWdlKCkgewogIGVjaG8gVXNhZ2U6ICQoYmFzZW5hbWUgJDApIFVOSVQgW2VudmZpbGUgW3Zhcm5hbWVdXQogIGVjaG8KICBlY2hvIEV4dHJhY3QgdGhlIGNvbnRlbnRzIG9mIHRoZSBmaXJzdCBFeGVjU3RhcnQgc3RhbnphIGZyb20gdGhlIGdpdmVuIHN5c3RlbWQgdW5pdCBhbmQgcmV0dXJuIGl0IHRvIHN0ZG91dAogIGVjaG8KICBlY2hvICJJZiAnZW52ZmlsZScgaXMgcHJvdmlkZWQsIHB1dCBpdCBpbiB0aGVyZSBpbnN0ZWFkLCBhcyBhbiBlbnZpcm9ubWVudCB2YXJpYWJsZSBuYW1lZCAndmFybmFtZSciCiAgZWNobyAiRGVmYXVsdCAndmFybmFtZScgaXMgRVhFQ1NUQVJUIGlmIG5vdCBzcGVjaWZpZWQiCiAgZXhpdCAxCn0KClVOSVQ9JDEKRU5WRklMRT0kMgpWQVJOQU1FPSQzCmlmIFtbIC16ICRVTklUIHx8ICRVTklUID09ICItLWhlbHAiIHx8ICRVTklUID09ICItaCIgXV07IHRoZW4KICB1c2FnZQpmaQpkZWJ1ZyAiRXh0cmFjdGluZyBFeGVjU3RhcnQgZnJvbSAkVU5JVCIKRklMRT0kKHN5c3RlbWN0bCBjYXQgJFVOSVQgfCBoZWFkIC1uIDEpCkZJTEU9JHtGSUxFI1wjIH0KaWYgW1sgISAtZiAkRklMRSBdXTsgdGhlbgogIGRlYnVnICJGYWlsZWQgdG8gZmluZCByb290IGZpbGUgZm9yIHVuaXQgJFVOSVQgKCRGSUxFKSIKICBleGl0CmZpCmRlYnVnICJTZXJ2aWNlIGRlZmluaXRpb24gaXMgaW4gJEZJTEUiCkVYRUNTVEFSVD0kKHNlZCAtbiAtZSAnL15FeGVjU3RhcnQ9LipcXCQvLC9bXlxcXSQvIHsgcy9eRXhlY1N0YXJ0PS8vOyBwIH0nIC1lICcvXkV4ZWNTdGFydD0uKlteXFxdJC8geyBzL15FeGVjU3RhcnQ9Ly87IHAgfScgJEZJTEUpCgppZiBbWyAkRU5WRklMRSBdXTsgdGhlbgogIFZBUk5BTUU9JHtWQVJOQU1FOi1FWEVDU1RBUlR9CiAgZWNobyAiJHtWQVJOQU1FfT0ke0VYRUNTVEFSVH0iID4gJEVOVkZJTEUKZWxzZQogIGVjaG8gJEVYRUNTVEFSVApmaQo=
        mode: 493
        path: /usr/local/bin/extractExecStart
      - contents:
          source: data:text/plain;charset=utf-8;base64,IyEvYmluL2Jhc2gKbnNlbnRlciAtLW1vdW50PS9ydW4vY29udGFpbmVyLW1vdW50LW5hbWVzcGFjZS9tbnQgIiRAIgo=
        mode: 493
        path: /usr/local/bin/nsenterCmns
    systemd:
      units:
      - contents: |
          [Unit]
          Description=Manages a mount namespace that both kubelet and crio can use to share their container-specific mounts

          [Service]
          Type=oneshot
          RemainAfterExit=yes
          RuntimeDirectory=container-mount-namespace
          Environment=RUNTIME_DIRECTORY=%t/container-mount-namespace
          Environment=BIND_POINT=%t/container-mount-namespace/mnt
          ExecStartPre=bash -c "findmnt ${RUNTIME_DIRECTORY} || mount --make-unbindable --bind ${RUNTIME_DIRECTORY} ${RUNTIME_DIRECTORY}"
          ExecStartPre=touch ${BIND_POINT}
          ExecStart=unshare --mount=${BIND_POINT} --propagation slave mount --make-rshared /
          ExecStop=umount -R ${RUNTIME_DIRECTORY}
        enabled: true
        name: container-mount-namespace.service
      - dropins:
        - contents: |
            # This generic drop-in allows adding additional executable wrappers to
            # ExecStart via the EXECSTART_WRAPPER environment variable, and extra arguments
            # to be added via EXECSTART_WRAPPER_EXTRA_ARGS

            [Service]
            ExecStartPre=/usr/local/bin/extractExecStart %n /%t/%N-execstart.env ORIG_EXECSTART
            EnvironmentFile=-/%t/%N-execstart.env
            ExecStart=
            ExecStart=bash -c "${EXECSTART_WRAPPER} \
                ${ORIG_EXECSTART} \
                ${EXECSTART_WRAPPER_EXTRA_ARGS}"
          name: 99-execstart-wrapper.conf
        - contents: |
            # This works in conjunction with 99-execstart-wrapper.conf to wrap the
            # executable in 'nsenter' so it runs in the container-private mount namespace
            # pinned by the 'container-mount-namespace.service' job.

            [Unit]
            Wants=container-mount-namespace.service
            After=container-mount-namespace.service

            [Service]
            Environment="EXECSTART_WRAPPER=nsenter --mount=%t/container-mount-namespace/mnt"
          name: 20-container-mount-namespace-wrapper.conf
        - contents: |
            # Addresses a collision in the way both 99-execstart-wrapper.conf and
            # 20-stream-address.conf patch ExecStart=, basically by redoing what
            # 20-stream-address.conf does using the EXECSTART_WRAPPER_EXTRA_ARGS environment facility provided by
            # 99-execstart-wrapper.conf, which is the exclusive patcher for ExecStart=

            [Service]
            Environment="EXECSTART_WRAPPER_EXTRA_ARGS=--stream-address=$CONTAINER_STREAM_ADDRESS"
          name: 30-crio-stream-address-env.conf
        name: crio.service
      - dropins:
        - contents: |
            # This generic drop-in allows adding additional executable wrappers to
            # ExecStart via the EXECSTART_WRAPPER environment variable, and extra arguments
            # to be added via EXECSTART_WRAPPER_EXTRA_ARGS

            [Service]
            ExecStartPre=/usr/local/bin/extractExecStart %n /%t/%N-execstart.env ORIG_EXECSTART
            EnvironmentFile=-/%t/%N-execstart.env
            ExecStart=
            ExecStart=bash -c "${EXECSTART_WRAPPER} \
                ${ORIG_EXECSTART} \
                ${EXECSTART_WRAPPER_EXTRA_ARGS}"
          name: 99-execstart-wrapper.conf
        - contents: |
            # This works in conjunction with 99-execstart-wrapper.conf to wrap the
            # executable in 'nsenter' so it runs in the container-private mount namespace
            # pinned by the 'container-mount-namespace.service' job.

            [Unit]
            Wants=container-mount-namespace.service
            After=container-mount-namespace.service

            [Service]
            Environment="EXECSTART_WRAPPER=nsenter --mount=%t/container-mount-namespace/mnt"
          name: 20-container-mount-namespace-wrapper.conf
        - contents: |
            # Works in conjunction with the original kubelet.service environment and an
            # additional override in 99-execstart-wrapper.conf to adjust all housekeeping
            # intervals

            [Service]
            Environment="OPENSHIFT_MAX_HOUSEKEEPING_INTERVAL_DURATION=60s"
            Environment="OPENSHIFT_EVICTION_MONITORING_PERIOD_DURATION=30s"
            Environment="EXECSTART_WRAPPER_EXTRA_ARGS=--housekeeping-interval=30s"
          name: 30-kubelet-interval-tuning.conf
        name: kubelet.service
